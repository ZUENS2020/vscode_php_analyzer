import * as vscode from 'vscode';
import { AnalysisResult, Vulnerability } from '../types';
import { PHPAnalyzer } from './phpAnalyzer';

interface VulnerabilityPattern {
    id: string;
    name: string;
    severity: 'critical' | 'high' | 'medium' | 'low';
    description: string;
    remediation: string;
    cwe?: string;
    check: (analyzer: PHPAnalyzer, document: vscode.TextDocument) => Vulnerability[];
}

export class VulnerabilityScanner {
    private ast: any;
    private analyzer: PHPAnalyzer;
    private patterns: VulnerabilityPattern[];

    constructor(ast: any) {
        this.ast = ast;
        this.analyzer = new PHPAnalyzer('');
        this.analyzer['ast'] = ast;
        this.patterns = this.initializePatterns();
    }

    scanVulnerabilities(document: vscode.TextDocument): AnalysisResult[] {
        const results: AnalysisResult[] = [];
        const vulnerabilities: Vulnerability[] = [];

        for (const pattern of this.patterns) {
            const found = pattern.check(this.analyzer, document);
            vulnerabilities.push(...found);
        }

        // Group by severity
        for (const vuln of vulnerabilities) {
            results.push({
                type: 'Vulnerability',
                severity: vuln.severity === 'critical' ? 'critical' : vuln.severity === 'high' ? 'error' : 'warning',
                message: `[${vuln.id}] ${vuln.name}`,
                location: vuln.location,
                details: this.formatVulnerabilityDetails(vuln),
                metadata: vuln
            });
        }

        return results;
    }

    private initializePatterns(): VulnerabilityPattern[] {
        return [
            // DESER-001: Unsafe unserialize
            {
                id: 'DESER-001',
                name: 'Unsafe Deserialization',
                severity: 'critical',
                description: 'User input directly passed to unserialize()',
                remediation: 'Avoid unserializing user input. Use JSON instead.',
                cwe: 'CWE-502',
                check: (analyzer, document) => {
                    const vulns: Vulnerability[] = [];
                    const calls = analyzer.getAllFunctionCalls();
                    
                    for (const call of calls) {
                        if (this.getFunctionName(call) === 'unserialize') {
                            const source = this.analyzeSource(call);
                            if (this.isUserInput(source)) {
                                const loc = this.getLocation(analyzer, call, document);
                                vulns.push({
                                    id: 'DESER-001',
                                    name: 'Unsafe Deserialization',
                                    severity: 'critical',
                                    description: `unserialize() called with user input from ${source}`,
                                    location: loc,
                                    remediation: 'Use JSON or implement allowed_classes whitelist',
                                    cwe: 'CWE-502'
                                });
                            }
                        }
                    }
                    
                    return vulns;
                }
            },

            // FUNC-001: eval usage
            {
                id: 'FUNC-001',
                name: 'eval() Usage',
                severity: 'critical',
                description: 'Use of eval() function',
                remediation: 'Avoid eval(). Use safer alternatives.',
                cwe: 'CWE-95',
                check: (analyzer, document) => {
                    const vulns: Vulnerability[] = [];
                    const calls = analyzer.getAllFunctionCalls();
                    
                    for (const call of calls) {
                        if (this.getFunctionName(call) === 'eval') {
                            const loc = this.getLocation(analyzer, call, document);
                            vulns.push({
                                id: 'FUNC-001',
                                name: 'eval() Usage',
                                severity: 'critical',
                                description: 'eval() is extremely dangerous and should be avoided',
                                location: loc,
                                remediation: 'Refactor code to eliminate eval()',
                                cwe: 'CWE-95'
                            });
                        }
                    }
                    
                    return vulns;
                }
            },

            // FUNC-003: Command injection
            {
                id: 'FUNC-003',
                name: 'Command Execution',
                severity: 'critical',
                description: 'Use of command execution functions',
                remediation: 'Validate and escape all inputs to command execution functions',
                cwe: 'CWE-78',
                check: (analyzer, document) => {
                    const vulns: Vulnerability[] = [];
                    const cmdFuncs = ['system', 'exec', 'passthru', 'shell_exec', 'popen', 'proc_open'];
                    const calls = analyzer.getAllFunctionCalls();
                    
                    for (const call of calls) {
                        const funcName = this.getFunctionName(call);
                        if (cmdFuncs.includes(funcName)) {
                            const loc = this.getLocation(analyzer, call, document);
                            vulns.push({
                                id: 'FUNC-003',
                                name: 'Command Execution',
                                severity: 'critical',
                                description: `Use of ${funcName}() can lead to command injection`,
                                location: loc,
                                remediation: 'Use escapeshellarg() and escapeshellcmd(), or avoid system commands',
                                cwe: 'CWE-78'
                            });
                        }
                    }
                    
                    return vulns;
                }
            },

            // FUNC-004: Dangerous callbacks
            {
                id: 'FUNC-004',
                name: 'Dangerous Callback',
                severity: 'high',
                description: 'Dynamic function calls can be exploited',
                remediation: 'Whitelist allowed callback functions',
                cwe: 'CWE-95',
                check: (analyzer, document) => {
                    const vulns: Vulnerability[] = [];
                    const callbackFuncs = ['call_user_func', 'call_user_func_array', 'array_map', 'array_filter'];
                    const calls = analyzer.getAllFunctionCalls();
                    
                    for (const call of calls) {
                        const funcName = this.getFunctionName(call);
                        if (callbackFuncs.includes(funcName)) {
                            const source = this.analyzeSource(call);
                            if (this.isUserInput(source)) {
                                const loc = this.getLocation(analyzer, call, document);
                                vulns.push({
                                    id: 'FUNC-004',
                                    name: 'Dangerous Callback',
                                    severity: 'high',
                                    description: `${funcName}() with user-controlled callback from ${source}`,
                                    location: loc,
                                    remediation: 'Implement a whitelist of allowed callbacks',
                                    cwe: 'CWE-95'
                                });
                            }
                        }
                    }
                    
                    return vulns;
                }
            },

            // MAGIC-002: Dangerous __destruct
            {
                id: 'MAGIC-002',
                name: 'Dangerous __destruct',
                severity: 'high',
                description: '__destruct contains dangerous operations',
                remediation: 'Avoid dangerous operations in __destruct',
                check: (analyzer, document) => {
                    const vulns: Vulnerability[] = [];
                    const classes = analyzer.getAllClasses();
                    
                    for (const classNode of classes) {
                        if (!classNode.body) continue;
                        
                        for (const member of classNode.body) {
                            if (member.kind === 'method' && (member.name?.name === '__destruct' || member.name === '__destruct')) {
                                const hasDangerous = this.hasDangerousOps(analyzer, member);
                                if (hasDangerous) {
                                    const loc = this.getLocation(analyzer, member, document);
                                    vulns.push({
                                        id: 'MAGIC-002',
                                        name: 'Dangerous __destruct',
                                        severity: 'high',
                                        description: '__destruct contains dangerous operations that could be exploited',
                                        location: loc,
                                        remediation: 'Remove dangerous operations from __destruct or add input validation'
                                    });
                                }
                            }
                        }
                    }
                    
                    return vulns;
                }
            },

            // PHAR-001: Phar deserialization
            {
                id: 'PHAR-001',
                name: 'Phar Deserialization',
                severity: 'high',
                description: 'File functions can trigger phar:// deserialization',
                remediation: 'Validate file paths and disable phar:// wrapper',
                cwe: 'CWE-502',
                check: (analyzer, document) => {
                    const vulns: Vulnerability[] = [];
                    const pharTriggers = ['file_exists', 'file_get_contents', 'fopen', 'getimagesize', 'is_file'];
                    const calls = analyzer.getAllFunctionCalls();
                    
                    for (const call of calls) {
                        const funcName = this.getFunctionName(call);
                        if (pharTriggers.includes(funcName)) {
                            const source = this.analyzeSource(call);
                            if (this.isUserInput(source)) {
                                const loc = this.getLocation(analyzer, call, document);
                                vulns.push({
                                    id: 'PHAR-001',
                                    name: 'Phar Deserialization',
                                    severity: 'high',
                                    description: `${funcName}() with user input can trigger phar:// deserialization`,
                                    location: loc,
                                    remediation: 'Validate paths with realpath() and basename()',
                                    cwe: 'CWE-502'
                                });
                            }
                        }
                    }
                    
                    return vulns;
                }
            }
        ];
    }

    private getFunctionName(callNode: any): string {
        if (!callNode.what) return '';
        if (typeof callNode.what.name === 'string') return callNode.what.name.toLowerCase();
        if (callNode.what.kind === 'name') return (callNode.what.name || '').toLowerCase();
        return '';
    }

    private analyzeSource(callNode: any): string {
        if (!callNode.arguments || callNode.arguments.length === 0) return 'unknown';
        const firstArg = callNode.arguments[0];
        
        if (firstArg.kind === 'variable') {
            return '$' + (firstArg.name || 'unknown');
        } else if (firstArg.kind === 'offsetlookup' && firstArg.what?.kind === 'variable') {
            return '$' + firstArg.what.name;
        }
        
        return firstArg.kind || 'unknown';
    }

    private isUserInput(source: string): boolean {
        const inputs = ['$_GET', '$_POST', '$_COOKIE', '$_REQUEST', '$_FILES', '$_SERVER'];
        return inputs.some(input => source.includes(input));
    }

    private hasDangerousOps(analyzer: PHPAnalyzer, node: any): boolean {
        let found = false;
        analyzer.traverse(node, (child) => {
            if (child.kind === 'call' && child.what) {
                const funcName = this.getFunctionName(child);
                if (analyzer.isDangerousFunction(funcName)) {
                    found = true;
                }
            }
        });
        return found;
    }

    private getLocation(analyzer: PHPAnalyzer, node: any, document: vscode.TextDocument): vscode.Location {
        const loc = analyzer.getNodeLocation(node);
        const position = loc ? new vscode.Position(loc.line, loc.character) : new vscode.Position(0, 0);
        return new vscode.Location(document.uri, position);
    }

    private formatVulnerabilityDetails(vuln: Vulnerability): string {
        let details = `ID: ${vuln.id}\n`;
        details += `Severity: ${vuln.severity.toUpperCase()}\n`;
        if (vuln.cwe) {
            details += `CWE: ${vuln.cwe}\n`;
        }
        details += `\nDescription:\n${vuln.description}\n`;
        details += `\nRemediation:\n${vuln.remediation}`;
        return details;
    }
}
