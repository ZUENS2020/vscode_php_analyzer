# PHP Security Analyzer - è¯¦ç»†å†å¼€å‘æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [é¡¹ç›®æ¶æ„](#é¡¹ç›®æ¶æ„)
3. [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#æ ¸å¿ƒç»„ä»¶è¯¦è§£)
4. [å¼€å‘ç¯å¢ƒæ­å»º](#å¼€å‘ç¯å¢ƒæ­å»º)
5. [å¸¸è§å¼€å‘ä»»åŠ¡](#å¸¸è§å¼€å‘ä»»åŠ¡)
6. [æ‰©å±•åŠŸèƒ½æŒ‡å—](#æ‰©å±•åŠŸèƒ½æŒ‡å—)
7. [æµ‹è¯•ä¸è°ƒè¯•](#æµ‹è¯•ä¸è°ƒè¯•)
8. [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)

---

## é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®å®šä½
**PHP Security Analyzer** æ˜¯ä¸€ä¸ª VS Code æ‰©å±•æ’ä»¶ï¼Œä¸“ä¸º CTFï¼ˆCapture The Flagï¼‰ç«èµ›è®¾è®¡ï¼Œç”¨äºæ£€æµ‹å’Œåˆ†æ PHP ä»£ç ä¸­çš„å®‰å…¨æ¼æ´ï¼Œç‰¹åˆ«æ˜¯åºåˆ—åŒ–æ¼æ´å’Œ POPï¼ˆProperty-Oriented Programmingï¼‰é“¾ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- ğŸ” **æ¼æ´æ£€æµ‹** - LFI/RFIã€SQLæ³¨å…¥ã€XXEã€å‘½ä»¤æ³¨å…¥ã€ååºåˆ—åŒ–ç­‰
- â›“ï¸ **POPé“¾åˆ†æ** - è‡ªåŠ¨è¯†åˆ«é­”æœ¯æ–¹æ³•ã€è¿½è¸ªå±æ€§æ³¨å…¥ã€æ„å»ºæ”»å‡»é“¾
- ğŸ“Š **ä»£ç ç»“æ„å¯è§†åŒ–** - Maltegoé£æ ¼çš„äº¤äº’å¼å›¾è¡¨å±•ç¤º
- ğŸ¯ **Payloadè‡ªåŠ¨ç”Ÿæˆ** - æ ¹æ®æ£€æµ‹ç»“æœç”Ÿæˆæ¼æ´åˆ©ç”¨ä»£ç 
- ğŸ”— **æ•°æ®æµè¿½è¸ª** - è¿½è¸ªæ•°æ®ä»æºåˆ°æ±‡çš„æµåŠ¨

### é¡¹ç›®ä¿¡æ¯
- **ç‰ˆæœ¬**: 1.0.0
- **å‘å¸ƒè€…**: ZUENS2020
- **å¼€å‘è¯­è¨€**: TypeScript
- **ç›®æ ‡å¹³å°**: VS Code 1.80.0+
- **è®¸å¯è¯**: MIT
- **ä»“åº“**: https://github.com/ZUENS2020/vscode_php_analyzer.git

---

## é¡¹ç›®æ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         VS Code Extension Host                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Extension Entry (src/extension.ts)                    â”‚
â”‚  â”œâ”€ Command Registration & Handler                     â”‚
â”‚  â”œâ”€ UI Components (TreeView, WebView)                  â”‚
â”‚  â””â”€ Event Listener (æ–‡ä»¶æ‰“å¼€ã€ä¿å­˜ç­‰)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Analyzer Layer (src/analyzers/)                       â”‚
â”‚  â”œâ”€ PHPAnalyzer (ASTè§£æ)                              â”‚
â”‚  â”œâ”€ VulnerabilityScanner (æ¼æ´æ£€æµ‹)                    â”‚
â”‚  â”œâ”€ POPChainDetector (POPé“¾æ£€æµ‹)                       â”‚
â”‚  â”œâ”€ ClassAnalyzer (ç±»åˆ†æ)                             â”‚
â”‚  â”œâ”€ MagicMethodDetector (é­”æœ¯æ–¹æ³•æ£€æµ‹)                â”‚
â”‚  â”œâ”€ DataFlowAnalyzer (æ•°æ®æµè¿½è¸ª)                      â”‚
â”‚  â””â”€ å…¶ä»–ä¸“ä¸šåˆ†æå™¨...                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Provider Layer (src/providers/)                       â”‚
â”‚  â”œâ”€ AnalysisResultsProvider (ç»“æœå±•ç¤º)                â”‚
â”‚  â””â”€ CodeGraphProvider (å›¾å½¢å±•ç¤º)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Server Layer (src/server/)                            â”‚
â”‚  â””â”€ GraphServer (Express WebæœåŠ¡å™¨)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Web Frontend (web/)                                   â”‚
â”‚  â”œâ”€ index.html (ä¸»ç•Œé¢)                                â”‚
â”‚  â”œâ”€ graph.js (å›¾å½¢æ¸²æŸ“)                                â”‚
â”‚  â”œâ”€ api.js (APIé€šä¿¡)                                   â”‚
â”‚  â””â”€ styles.css (æ ·å¼)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
PHPæºä»£ç 
    â†“
PHPAnalyzer (PHP-Parseråº“)
    â†“ (ç”ŸæˆAST)
â”œâ”€â†’ VulnerabilityScanner â†’ æ¼æ´æ£€æµ‹ç»“æœ
â”œâ”€â†’ POPChainDetector â†’ POPé“¾æ£€æµ‹ç»“æœ
â”œâ”€â†’ ClassAnalyzer â†’ ç±»ç»“æ„ä¿¡æ¯
â”œâ”€â†’ DataFlowAnalyzer â†’ æ•°æ®æµä¿¡æ¯
â””â”€â†’ AttackChainAnalyzer â†’ æ”»å‡»é“¾ä¿¡æ¯
    â†“
UIå±•ç¤º (TreeView + WebView)
    â†“
PayloadGenerator â†’ åˆ©ç”¨ä»£ç ç”Ÿæˆ
    â†“
GraphServer â†’ å¯è§†åŒ–å±•ç¤º
```

---

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. å…¥å£æ–‡ä»¶ (src/extension.ts)

**èŒè´£**: VS Codeæ‰©å±•çš„ä¸»å…¥å£ï¼Œç®¡ç†æ‰©å±•çš„ç”Ÿå‘½å‘¨æœŸå’Œå‘½ä»¤æ³¨å†Œ

**å…³é”®å‡½æ•°**:
```typescript
export function activate(context: vscode.ExtensionContext)
```
åœ¨æ‰©å±•å¯åŠ¨æ—¶è°ƒç”¨ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
- æ³¨å†Œæ‰€æœ‰å‘½ä»¤å¤„ç†å™¨
- åˆå§‹åŒ–UIç»„ä»¶ï¼ˆTreeViewï¼‰
- å¯åŠ¨GraphServer
- æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨

**ä¸»è¦å‘½ä»¤**:
| å‘½ä»¤ID | åŠŸèƒ½ | è§¦å‘ä½ç½® |
|--------|------|---------|
| phpAnalyzer.analyzeClassRelations | åˆ†æç±»å…³ç³» | å³é”®èœå• |
| phpAnalyzer.findPOPChain | æŸ¥æ‰¾POPé“¾ | å³é”®èœå• |
| phpAnalyzer.fullSecurityAnalysis | å®Œæ•´å®‰å…¨åˆ†æ | ç¼–è¾‘å™¨æ ‡é¢˜æ  |
| phpAnalyzer.scanVulnerabilities | æ‰«ææ¼æ´ | å³é”®èœå• |
| phpAnalyzer.generateExploitPayload | ç”Ÿæˆåˆ©ç”¨ä»£ç  | å‘½ä»¤é¢æ¿ |
| phpAnalyzer.showCodeGraph | æ˜¾ç¤ºä»£ç å›¾ | å³é”®èœå• |

**é‡è¦å…¨å±€å˜é‡**:
- `graphServer: GraphServer` - Webå¯è§†åŒ–æœåŠ¡å™¨å®ä¾‹
- `highlightDecorationType: vscode.TextEditorDecorationType` - ä»£ç é«˜äº®è£…é¥°

### 2. PHP è§£æå™¨ (src/analyzers/phpAnalyzer.ts)

**èŒè´£**: ä½¿ç”¨php-parseråº“è§£æPHPä»£ç ç”ŸæˆASTï¼Œæä¾›ASTéå†å’ŒæŸ¥è¯¢æ¥å£

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
// ç”ŸæˆAST
constructor(code: string)

// ASTéå†
traverse(node: any, callback: (node: any, parent: any) => void, parent?: any)

// æŸ¥è¯¢æ–¹æ³•
findNodesByType(type: string): any[]
findClassByName(className: string): any | null
findMethodInClass(className: string, methodName: string): any | null
getAllClasses(): any[]
getAllFunctionCalls(): any[]
getAllAssignments(): any[]

// åˆ†ç±»æ–¹æ³•
isMagicMethod(methodName: string): boolean
isDangerousFunction(functionName: string): boolean
isUserInputSource(varName: string): boolean
getNodeLocation(node: any): { line: number; character: number } | null
```

**æ”¯æŒçš„å±é™©å‡½æ•°åˆ—è¡¨**:
- ä»£ç æ‰§è¡Œ: eval, assert, system, exec, shell_exec, passthruç­‰
- ååºåˆ—åŒ–: unserialize
- æ–‡ä»¶æ“ä½œ: include, require, file_get_contents, file_put_contentsç­‰
- åŠ¨æ€è°ƒç”¨: call_user_func, call_user_func_array, create_function
- å…¶ä»–: extract, parse_str, putenvç­‰

**æ”¯æŒçš„é­”æœ¯æ–¹æ³•**:
- `__construct`, `__destruct`, `__call`, `__callStatic`
- `__get`, `__set`, `__isset`, `__unset`
- `__sleep`, `__wakeup`, `__serialize`, `__unserialize`
- `__toString`, `__invoke`, `__set_state`, `__clone`, `__debugInfo`

**ç”¨æˆ·è¾“å…¥æº**:
- `$_GET`, `$_POST`, `$_COOKIE`, `$_REQUEST`, `$_FILES`, `$_SERVER`, `$_ENV`

### 3. æ¼æ´æ‰«æå™¨ (src/analyzers/vulnerabilityScanner.ts)

**èŒè´£**: å®ç°å…·ä½“çš„æ¼æ´æ£€æµ‹æ¨¡å¼ï¼Œæ‰«æPHPä»£ç ä¸­çš„å®‰å…¨æ¼æ´

**æ ¸å¿ƒåŠŸèƒ½**:
- **æ±¡ç‚¹è¿½è¸ª** - buildTaintMap()æ–¹æ³•è·Ÿè¸ªå˜é‡æ˜¯å¦æ¥è‡ªç”¨æˆ·è¾“å…¥
- **æ¨¡å¼åŒ¹é…** - å®šä¹‰å¤šç§æ¼æ´æ£€æµ‹æ¨¡å¼ï¼Œæ¯ä¸ªæ¨¡å¼åŒ…å«æ£€æŸ¥è§„åˆ™
- **ä¸¥é‡æ€§åˆ†çº§** - critical (ä¸¥é‡)ã€high (é«˜)ã€medium (ä¸­)ã€low (ä½)

**æ”¯æŒçš„æ¼æ´ç±»å‹**:
| æ¼æ´ID | åç§° | ä¸¥é‡æ€§ | CWE |
|--------|------|--------|-----|
| DESER-001 | ä¸å®‰å…¨ååºåˆ—åŒ– | critical | CWE-502 |
| DESER-002 | ååºåˆ—åŒ–ç›®æ ‡æ£€æŸ¥ç¼ºå¤± | high | CWE-502 |
| INJ-001 | SQLæ³¨å…¥ | critical | CWE-89 |
| INJ-002 | å‘½ä»¤æ³¨å…¥ | critical | CWE-78 |
| INJ-003 | LDAPæ³¨å…¥ | high | CWE-90 |
| PATH-001 | è·¯å¾„éå† | high | CWE-22 |
| XXE-001 | XXEæ”»å‡» | critical | CWE-611 |
| FUNC-001 | ä½¿ç”¨å±é™©å‡½æ•° | medium | CWE-95 |

**å…³é”®æ–¹æ³•**:
```typescript
// æ„å»ºæ±¡ç‚¹æ˜ å°„
private buildTaintMap(): void

// è·å–è¶…çº§å…¨å±€å˜é‡æ¥æº
private getSuperGlobalFromNode(node: any): string | ''

// æ‰«ææ‰€æœ‰æ¼æ´
scanVulnerabilities(document: vscode.TextDocument): AnalysisResult[]

// åˆå§‹åŒ–æ£€æµ‹æ¨¡å¼
private initializePatterns(): VulnerabilityPattern[]

// åˆ†ææ±¡æŸ“æº
private analyzeSource(node: any): string

// åˆ¤æ–­æ˜¯å¦æ¥è‡ªç”¨æˆ·è¾“å…¥
private isUserInput(source: string): boolean
```

### 4. POPé“¾æ£€æµ‹å™¨ (src/analyzers/popChainDetector.ts)

**èŒè´£**: æ£€æµ‹å’Œåˆ†æPHPååºåˆ—åŒ–POPï¼ˆProperty-Oriented Programmingï¼‰é“¾

**æ ¸å¿ƒæ¥å£**:

```typescript
// POPé“¾æ­¥éª¤
interface ChainStep {
    className: string;           // ç±»å
    methodName: string;          // æ–¹æ³•å
    trigger: string;             // è§¦å‘æ¡ä»¶
    description: string;         // æè¿°
    line: number;                // è¡Œå·
    propertyName?: string;       // ä½¿ç”¨çš„å±æ€§å
    propertyValue?: string;      // å±æ€§å€¼
    reads: string[];             // è¯»æ“ä½œ
    writes: string[];            // å†™æ“ä½œ
    calls: string[];             // è°ƒç”¨
    operations: string[];        // å…¶ä»–æ“ä½œ
    codePattern?: string;        // ä»£ç æ¨¡å¼
}

// å®Œæ•´çš„POPé“¾ç»“æœ
interface POPChainResult {
    entryClass: string;          // å…¥å£ç±»
    entryMethod: string;         // å…¥å£æ–¹æ³•
    steps: ChainStep[];          // é“¾çš„æ­¥éª¤
    finalSink: string;           // æœ€ç»ˆæ±‡ç‚¹ï¼ˆå±é™©å‡½æ•°ï¼‰
    riskLevel: 'critical' | 'high' | 'medium' | 'low';
    payload: string;             // åºåˆ—åŒ–Payloadä»£ç 
    description: string;         // é“¾æè¿°
    exploitMethod: string;       // åˆ©ç”¨æ–¹æ³•
    dataFlow: string;            // æ•°æ®æµæè¿°
    payloadObject?: PayloadObject; // ç»“æ„åŒ–Payloadå¯¹è±¡
    paramName?: string;          // unserializeå‚æ•°å
}
```

**æ ¸å¿ƒåˆ†ææµç¨‹**:

1. **è¯†åˆ«å…¥å£ç‚¹** - æŸ¥æ‰¾unserialize()è°ƒç”¨
2. **è¿½è¸ªé­”æœ¯æ–¹æ³•** - æ‰¾åˆ°__destructã€__wakeupç­‰æ–¹æ³•
3. **å±æ€§æ³¨å…¥åˆ†æ** - ç¡®å®šå“ªäº›å±æ€§å¯è¢«å¤–éƒ¨æ§åˆ¶
4. **å±é™©æ“ä½œè¯†åˆ«** - æ‰¾åˆ°æœ€ç»ˆçš„ä»£ç æ‰§è¡Œç‚¹
5. **é“¾è¿æ¥** - è¿æ¥å„ä¸ªgadgetå½¢æˆå®Œæ•´çš„attack chain
6. **Payloadç”Ÿæˆ** - ç”Ÿæˆå¯åºåˆ—åŒ–çš„Payloadä»£ç 

**å…³é”®æ–¹æ³•**:
```typescript
// æ£€æµ‹POPé“¾
detectPOPChains(code: string, className?: string): POPChainResult[]

// è¿½è¸ªå±æ€§ä½¿ç”¨
tracePropertyUsage(methodNode: any): PropertyUsage[]

// æŸ¥æ‰¾å±é™©è°ƒç”¨
findDangerousCalls(methodNode: any): DangerousCall[]

// æ„å»ºPayload
buildPayload(chain: POPChainResult): PayloadObject

// è¿½è¸ª__wakeupç»•è¿‡
findWakeupBypass(classNode: any): boolean
```

### 5. ç±»åˆ†æå™¨ (src/analyzers/classAnalyzer.ts)

**èŒè´£**: æå–å’Œåˆ†æPHPç±»çš„ç»“æ„ä¿¡æ¯

**æå–ä¿¡æ¯**:
- ç±»åã€å‘½åç©ºé—´ã€ç»§æ‰¿å…³ç³»
- å±æ€§ï¼ˆè®¿é—®æƒé™ã€é»˜è®¤å€¼ï¼‰
- æ–¹æ³•ï¼ˆç­¾åã€å‚æ•°ã€è¿”å›ç±»å‹ï¼‰
- é­”æœ¯æ–¹æ³•åŠå…¶å±é™©æ€§
- å®ç°çš„æ¥å£

**è¾“å‡ºç»“æœç±»å‹**:
```typescript
interface ClassInfo {
    name: string;
    namespace?: string;
    extends?: string;              // çˆ¶ç±»
    implements: string[];          // å®ç°çš„æ¥å£
    properties: PropertyInfo[];
    methods: MethodInfo[];
    magicMethods: MagicMethod[];
    location: vscode.Location;
}
```

### 6. é­”æœ¯æ–¹æ³•æ£€æµ‹å™¨ (src/analyzers/magicMethodDetector.ts)

**èŒè´£**: æ£€æµ‹å’Œåˆ†æPHPé­”æœ¯æ–¹æ³•

**åˆ†æå†…å®¹**:
- é­”æœ¯æ–¹æ³•åœ¨ä»£ç ä¸­çš„ä½ç½®
- å±é™©çš„é­”æœ¯æ–¹æ³•è¯†åˆ«
- é­”æœ¯æ–¹æ³•å†…çš„å±é™©æ“ä½œ
- è§¦å‘æ¡ä»¶è¯´æ˜

**å±é™©åˆ¤æ–­æ ‡å‡†**:
ä¸€ä¸ªé­”æœ¯æ–¹æ³•è¢«è®¤ä¸ºæ˜¯å±é™©çš„ï¼Œå¦‚æœå®ƒåŒ…å«ä»¥ä¸‹æ“ä½œï¼š
- è°ƒç”¨å±é™©å‡½æ•°ï¼ˆeval, system, unserializeç­‰ï¼‰
- ä½¿ç”¨ç”¨æˆ·å¯æ§çš„å±æ€§ä½œä¸ºå‚æ•°
- æ‰§è¡Œæ–‡ä»¶æ“ä½œã€æ•°æ®åº“æ“ä½œç­‰æ•æ„Ÿæ“ä½œ

### 7. æ•°æ®æµåˆ†æå™¨ (src/analyzers/dataFlowAnalyzer.ts)

**èŒè´£**: è¿½è¸ªæ•°æ®ä»æºç‚¹åˆ°æ±‡ç‚¹çš„æµåŠ¨

**åˆ†æåŠŸèƒ½**:
- è¿½è¸ªå˜é‡èµ‹å€¼é“¾
- è¯†åˆ«æ•°æ®æ¥æºï¼ˆç”¨æˆ·è¾“å…¥ã€æ–‡ä»¶ã€ç½‘ç»œç­‰ï¼‰
- è¿½è¸ªå±é™©å‡½æ•°çš„å‚æ•°æ¥æº
- ç”Ÿæˆæ•°æ®æµå›¾

### 8. æ”»å‡»é“¾åˆ†æå™¨ (src/analyzers/attackChainAnalyzer.ts)

**èŒè´£**: åˆ†æå¹¶è¿æ¥å¤šä¸ªæ¼æ´ç‚¹å½¢æˆå®Œæ•´çš„æ”»å‡»é“¾

**åˆ†ææ­¥éª¤**:
1. è¯†åˆ«å„ä¸ªæ¼æ´ç‚¹
2. åˆ†æå®ƒä»¬ä¹‹é—´çš„ä¾èµ–å…³ç³»
3. æ„å»ºæ”»å‡»å›¾
4. è®¡ç®—å¯åˆ©ç”¨æ€§è¯„åˆ†
5. ç”Ÿæˆæ”»å‡»é“¾æè¿°

### 9. åˆ†æç»“æœæä¾›è€… (src/providers/analysisResultsProvider.ts)

**èŒè´£**: åœ¨VS Codeä¾§æ TreeViewä¸­å±•ç¤ºåˆ†æç»“æœ

**åŠŸèƒ½**:
- ç»„ç»‡å’Œå±•ç¤ºåˆ†æç»“æœ
- æä¾›ç»“æœåˆ†ç±»ï¼ˆæ¼æ´ã€POPé“¾ã€ç±»ä¿¡æ¯ç­‰ï¼‰
- æ”¯æŒç‚¹å‡»ç»“æœè·³è½¬åˆ°ä»£ç ä½ç½®
- å®ç°æ ‘å½¢ç»“æ„çš„å±‚çº§å±•ç¤º

### 10. ä»£ç å›¾æä¾›è€… (src/providers/codeGraphProvider.ts)

**èŒè´£**: ç”Ÿæˆå’Œç®¡ç†ä»£ç ç»“æ„çš„å›¾å½¢è¡¨ç¤º

**æä¾›çš„å›¾ç±»å‹**:
- ä»£ç ç»“æ„å›¾ - ç±»ã€æ–¹æ³•ã€å‡½æ•°çš„å…³ç³»
- ç»§æ‰¿å›¾ - ç±»çš„ç»§æ‰¿å…³ç³»
- æ•°æ®æµå›¾ - æ•°æ®æµå‘
- æ”»å‡»é“¾å›¾ - POPé“¾å’Œæ”»å‡»è·¯å¾„

### 11. å›¾è¡¨æœåŠ¡å™¨ (src/server/graphServer.ts)

**èŒè´£**: æä¾›Express WebæœåŠ¡å™¨ï¼Œé€šè¿‡REST APIæä¾›å›¾å½¢æ•°æ®

**ä¸»è¦APIç«¯ç‚¹**:
```
GET /api/health                    - å¥åº·æ£€æŸ¥
GET /api/analysis/:fileHash        - è·å–åˆ†ææ•°æ®
GET /api/graph/code                - è·å–ä»£ç ç»“æ„å›¾
GET /api/graph/inheritance         - è·å–ç»§æ‰¿å›¾
GET /api/graph/dataflow            - è·å–æ•°æ®æµå›¾
GET /api/graph/attackchain         - è·å–æ”»å‡»é“¾å›¾
POST /api/analysis                 - æäº¤æ–°åˆ†æ
POST /api/highlight                - é«˜äº®è¯·æ±‚
```

**é…ç½®å‚æ•°**:
- `graphServerPort` (default: 3000) - æœåŠ¡å™¨ç«¯å£

### 12. Payloadç”Ÿæˆå™¨ (src/utils/payloadGenerator.ts)

**èŒè´£**: æ ¹æ®æ£€æµ‹çš„æ¼æ´å’Œæ”»å‡»é“¾è‡ªåŠ¨ç”Ÿæˆæ¼æ´åˆ©ç”¨ä»£ç 

**ç”Ÿæˆç±»å‹**:
- ååºåˆ—åŒ–Payload
- Pharååºåˆ—åŒ–Payload
- é€šç”¨Payloadæ¨¡æ¿

**ç”Ÿæˆå†…å®¹**:
- å®Œæ•´çš„PHPæ¼æ´åˆ©ç”¨è„šæœ¬
- Payloadåºåˆ—åŒ–ä»£ç 
- Base64ç¼–ç ç‰ˆæœ¬
- ä½¿ç”¨è¯´æ˜å’Œå‰ç½®æ¡ä»¶
- é˜²æŠ¤å»ºè®®

---

## å¼€å‘ç¯å¢ƒæ­å»º

### ç¯å¢ƒè¦æ±‚
- **Node.js**: v16.0.0+
- **npm**: v7.0.0+
- **VS Code**: v1.80.0+
- **TypeScript**: v4.9.0+

### å¿«é€Ÿå¼€å§‹

**1. å…‹éš†ä»“åº“**
```bash
git clone https://github.com/ZUENS2020/vscode_php_analyzer.git
cd vscode_php_analyzer
```

**2. å®‰è£…ä¾èµ–**
```bash
npm install
```

**3. ç¼–è¯‘TypeScript**
```bash
npm run compile
```

**4. å¯åŠ¨è°ƒè¯•æ¨¡å¼**
```bash
# æ–¹å¼1: åœ¨VS Codeä¸­æŒ‰ F5
# æ–¹å¼2: ä»å‘½ä»¤è¡Œå¯åŠ¨
npm run watch
```

### é¡¹ç›®ä¾èµ–

**package.json æ ¸å¿ƒä¾èµ–**:
```json
{
  "vscode": "^1.80.0",           // VS Code API
  "php-parser": "^3.0.0",        // PHPä»£ç è§£æ
  "express": "^4.18.0",          // WebæœåŠ¡å™¨
  "cors": "^2.8.5",              // è·¨åŸŸè¯·æ±‚
  "typescript": "^5.0.0",        // TypeScriptç¼–è¯‘å™¨
  "@types/node": "^20.0.0"       // Node.jsç±»å‹å®šä¹‰
}
```

### å¼€å‘å·¥å…·é…ç½®

**tsconfig.json å…³é”®é…ç½®**:
```json
{
  "compilerOptions": {
    "module": "commonjs",        // æ¨¡å—ç³»ç»Ÿ
    "target": "ES2020",          // ç¼–è¯‘ç›®æ ‡
    "outDir": "out",             // è¾“å‡ºç›®å½•
    "lib": ["ES2020"],           // åº“æ–‡ä»¶
    "sourceMap": true,           // ç”Ÿæˆæºæ˜ å°„
    "strict": true,              // ä¸¥æ ¼ç±»å‹æ£€æŸ¥
    "esModuleInterop": true      // ESæ¨¡å—äº’æ“ä½œ
  }
}
```

### VS Code æ‰©å±•é…ç½® (package.json ä¸­çš„ contributes)

**package.json æ‰©å±•å®šä¹‰**:
```json
{
  "activationEvents": [
    "onStartupFinished",         // å¯åŠ¨æ—¶æ¿€æ´»
    "onLanguage:php"             // æ‰“å¼€PHPæ–‡ä»¶æ—¶æ¿€æ´»
  ],
  "main": "./out/extension.js",  // å…¥å£æ–‡ä»¶
  "contributes": {
    "commands": [...],           // å‘½ä»¤å®šä¹‰
    "menus": {...},              // èœå•å®šä¹‰
    "viewsContainers": {...},    // ä¾§æ å®¹å™¨
    "views": {...},              // ä¾§æ è§†å›¾
    "configuration": {...}       // è®¾ç½®é¡¹
  }
}
```

---

## å¸¸è§å¼€å‘ä»»åŠ¡

### ä»»åŠ¡1: æ·»åŠ æ–°çš„æ¼æ´æ£€æµ‹æ¨¡å¼

**æ­¥éª¤**:

1. **åœ¨ VulnerabilityScanner.ts ä¸­æ·»åŠ æ£€æµ‹æ¨¡å¼**

```typescript
// åœ¨ initializePatterns() æ–¹æ³•ä¸­æ·»åŠ æ–°çš„æ¨¡å¼
{
    id: 'CUSTOM-001',
    name: 'è‡ªå®šä¹‰æ¼æ´åç§°',
    severity: 'high',
    description: 'æ¼æ´æè¿°',
    remediation: 'ä¿®å¤å»ºè®®',
    cwe: 'CWE-XXXX',
    check: (analyzer, document) => {
        const vulns: Vulnerability[] = [];
        
        // å®ç°æ£€æµ‹é€»è¾‘
        // éå†ASTï¼ŒæŸ¥æ‰¾æ¼æ´æ¨¡å¼
        
        return vulns;
    }
}
```

2. **å®ç°æ£€æµ‹é€»è¾‘**
```typescript
// æŸ¥æ‰¾ç‰¹å®šçš„å‡½æ•°è°ƒç”¨ã€èµ‹å€¼ã€æ¡ä»¶ç­‰
analyzer.traverse(ast, (node) => {
    if (node.kind === 'call' && isSuspicious(node)) {
        // æ·»åŠ æ¼æ´æŠ¥å‘Š
        vulns.push({
            id: 'CUSTOM-001',
            name: '...',
            severity: 'high',
            description: '...',
            location: getLocation(node, document),
            remediation: '...',
            cwe: 'CWE-XXXX'
        });
    }
});
```

3. **æµ‹è¯•æ–°æ·»åŠ çš„æ£€æµ‹**
```typescript
// åˆ›å»ºæµ‹è¯•PHPæ–‡ä»¶ï¼ŒéªŒè¯æ£€æµ‹æ•ˆæœ
// ä½¿ç”¨ npm run test è¿è¡Œæµ‹è¯•
```

### ä»»åŠ¡2: æ‰©å±•é­”æœ¯æ–¹æ³•æ£€æµ‹

**æ­¥éª¤**:

1. **æ›´æ–°é­”æœ¯æ–¹æ³•åˆ—è¡¨** (åœ¨ PHPAnalyzer.ts ä¸­)
```typescript
isMagicMethod(methodName: string): boolean {
    const magicMethods = [
        '__construct', '__destruct', '__call', '__callStatic',
        '__get', '__set', '__isset', '__unset',
        '__sleep', '__wakeup', '__serialize', '__unserialize',
        '__toString', '__invoke', '__set_state', '__clone', 
        '__debugInfo',
        // æ·»åŠ æ–°çš„é­”æœ¯æ–¹æ³•
        '__newMagicMethod'
    ];
    return magicMethods.includes(methodName);
}
```

2. **æ›´æ–°é­”æœ¯æ–¹æ³•è§¦å‘ä¿¡æ¯** (åœ¨ popChainDetector.ts ä¸­)
```typescript
const MAGIC_METHODS: Record<string, string> = {
    // ...
    '__newMagicMethod': 'è‡ªå®šä¹‰è§¦å‘æ¡ä»¶æè¿°'
};
```

3. **æ‰©å±•å±é™©æ€§åˆ†æ** (åœ¨ magicMethodDetector.ts ä¸­)
```typescript
private getMagicMethodDetails(methodName: string, dangerousOps: string[]): string {
    const descriptions: { [key: string]: string } = {
        // ...
        '__newMagicMethod': 'æ–°é­”æœ¯æ–¹æ³•çš„è¯¦ç»†è¯´æ˜'
    };
    // ...
}
```

### ä»»åŠ¡3: æ”¹è¿›POPé“¾æ£€æµ‹ç®—æ³•

**å½“å‰é—®é¢˜**:
- å¯èƒ½é—æ¼é—´æ¥çš„å±æ€§å¼•ç”¨
- æŸäº›å¤æ‚çš„æ•°æ®æµæ²¡æœ‰è¢«è¿½è¸ª

**æ”¹è¿›æ–¹æ¡ˆ**:

1. **å¢å¼ºå±æ€§è¿½è¸ª**
```typescript
// æ”¹è¿› tracePropertyUsage æ–¹æ³•ï¼Œæ”¯æŒï¼š
// - åŠ¨æ€å±æ€§è®¿é—® ($this->$propName)
// - æ•°ç»„å½¢å¼çš„å±æ€§ ($this->props['key'])
// - é€šè¿‡æ–¹æ³•è¿”å›çš„å±æ€§å¼•ç”¨
```

2. **å¢å¼ºé­”æœ¯æ–¹æ³•æ£€æµ‹**
```typescript
// æ”¯æŒ __get/__set çš„å±æ€§åŠ¨æ€è®¿é—®
// æ”¯æŒ __call çš„åŠ¨æ€æ–¹æ³•è°ƒç”¨
// æ”¯æŒåµŒå¥—çš„é­”æœ¯æ–¹æ³•è°ƒç”¨
```

3. **æ”¹è¿›Payloadç”Ÿæˆ**
```typescript
// è‡ªåŠ¨è¯†åˆ«æ­£ç¡®çš„å±æ€§ç±»å‹
// ç”Ÿæˆæ›´ç°å®çš„Payloadç»“æ„
// æ”¯æŒæ›´å¤šçš„gadget library
```

### ä»»åŠ¡4: æ·»åŠ æ–°çš„åˆ†æå‘½ä»¤

**æ­¥éª¤**:

1. **åœ¨ extension.ts ä¸­æ³¨å†Œå‘½ä»¤**
```typescript
context.subscriptions.push(
    vscode.commands.registerCommand('phpAnalyzer.newCommand', async () => {
        await newCommandHandler(analysisResultsProvider, codeGraphProvider);
    })
);
```

2. **åœ¨ package.json ä¸­æ·»åŠ å‘½ä»¤å®šä¹‰**
```json
{
    "command": "phpAnalyzer.newCommand",
    "title": "PHP Analyzer: New Command Title"
}
```

3. **åœ¨ package.json menus ä¸­æ·»åŠ èœå•é¡¹**
```json
{
    "command": "phpAnalyzer.newCommand",
    "when": "resourceLangId == php",
    "group": "phpAnalyzer@5"
}
```

4. **å®ç°å¤„ç†å‡½æ•°**
```typescript
async function newCommandHandler(
    analysisResultsProvider: AnalysisResultsProvider,
    codeGraphProvider: CodeGraphProvider
) {
    const editor = vscode.window.activeTextEditor;
    if (!editor) {
        vscode.window.showErrorMessage('No active editor');
        return;
    }

    try {
        const code = editor.document.getText();
        // æ‰§è¡Œåˆ†æé€»è¾‘
        const results = performAnalysis(code);
        
        // æ›´æ–°UI
        analysisResultsProvider.updateResults('New Analysis', results);
    } catch (error) {
        vscode.window.showErrorMessage(`Error: ${error}`);
    }
}
```

### ä»»åŠ¡5: æ”¹è¿›Webå‰ç«¯å¯è§†åŒ–

**å½“å‰æŠ€æœ¯æ ˆ**:
- HTML5 Canvas / SVG ç”¨äºå›¾å½¢æ¸²æŸ“
- åŸç”ŸJavaScriptå¤„ç†äº¤äº’
- CSS for æ ·å¼

**æ”¹è¿›å»ºè®®**:

1. **é›†æˆå›¾å½¢åº“** (å¯é€‰)
```bash
npm install d3 vis-network cytoscape
```

2. **å¢å¼ºå›¾å½¢åŠŸèƒ½**
- æ‹–æ‹½èŠ‚ç‚¹
- ç¼©æ”¾å¹³ç§»
- é«˜äº®è·¯å¾„
- å¯¼å‡ºåŠŸèƒ½

3. **æ”¹è¿›ç”¨æˆ·ä½“éªŒ**
- åŠ è½½åŠ¨ç”»
- èŠ‚ç‚¹æœç´¢
- é«˜çº§ç­›é€‰
- ä¸»é¢˜åˆ‡æ¢

---

## æ‰©å±•åŠŸèƒ½æŒ‡å—

### åŠŸèƒ½1: æ”¯æŒæ›´å¤šæ¼æ´ç±»å‹

#### SSRF (æœåŠ¡ç«¯è¯·æ±‚ä¼ªé€ ) æ£€æµ‹

**å®ç°æ­¥éª¤**:

1. åœ¨ `vulnerabilityScanner.ts` ä¸­æ·»åŠ :
```typescript
{
    id: 'SSRF-001',
    name: 'Server-Side Request Forgery',
    severity: 'high',
    description: 'User-controlled URL passed to remote access function',
    remediation: 'Validate and whitelist URLs, use allowlist for domains',
    cwe: 'CWE-918',
    check: (analyzer, document) => {
        const vulns: Vulnerability[] = [];
        const ssrfFunctions = ['curl_exec', 'file_get_contents', 'fopen', 'stream_get_contents'];
        
        // æ£€æµ‹ç”¨æˆ·è¾“å…¥çš„URLè¢«ä¼ é€’ç»™è¿™äº›å‡½æ•°
        analyzer.getAllFunctionCalls().forEach(call => {
            const funcName = analyzer.getFunctionName(call);
            if (ssrfFunctions.includes(funcName)) {
                const source = analyzeArgumentSource(call.arguments[0]);
                if (isUserInput(source)) {
                    vulns.push({
                        id: 'SSRF-001',
                        // ... å…¶ä»–å­—æ®µ
                    });
                }
            }
        });
        
        return vulns;
    }
}
```

#### TOCTOU (Time-of-check-time-of-use) æ£€æµ‹

**å®ç°æ­¥éª¤**:

1. è¿½è¸ªæ–‡ä»¶æ£€æŸ¥ä¸ä½¿ç”¨ä¹‹é—´çš„æ—¶é—´å·®
2. è¯†åˆ«éåŸå­æ“ä½œæ¨¡å¼
3. ç”Ÿæˆè­¦å‘Šå’Œä¿®å¤å»ºè®®

### åŠŸèƒ½2: æ”¯æŒè‡ªå®šä¹‰æ¼æ´è§„åˆ™

#### åˆ›å»ºè§„åˆ™å¼•æ“

```typescript
// æ–°æ–‡ä»¶: src/analyzers/customRuleEngine.ts

export interface CustomRule {
    id: string;
    name: string;
    pattern: string;         // æ­£åˆ™è¡¨è¾¾å¼æˆ–è‡ªå®šä¹‰DSL
    severity: 'critical' | 'high' | 'medium' | 'low';
    remediation: string;
}

export class CustomRuleEngine {
    private rules: Map<string, CustomRule> = new Map();

    loadRulesFromFile(filePath: string): void {
        // ä»JSONæˆ–YAMLæ–‡ä»¶åŠ è½½è§„åˆ™
    }

    applyRules(ast: any, analyzer: PHPAnalyzer): Vulnerability[] {
        const results: Vulnerability[] = [];
        
        for (const rule of this.rules.values()) {
            // åº”ç”¨æ¯ä¸ªè§„åˆ™
        }
        
        return results;
    }
}
```

### åŠŸèƒ½3: é›†æˆé™æ€åˆ†æå·¥å…·

#### PHPStan é›†æˆ

```typescript
// src/integration/phpstanIntegration.ts

import { exec } from 'child_process';

export class PHPStanIntegration {
    async analyzeWithPHPStan(filePath: string): Promise<AnalysisResult[]> {
        return new Promise((resolve, reject) => {
            exec(`phpstan analyze ${filePath}`, (error, stdout, stderr) => {
                if (error) {
                    reject(error);
                }
                const results = this.parsePHPStanOutput(stdout);
                resolve(results);
            });
        });
    }

    private parsePHPStanOutput(output: string): AnalysisResult[] {
        // è§£æPHPStanè¾“å‡ºå¹¶è½¬æ¢ä¸ºæ’ä»¶çš„ç»“æœæ ¼å¼
        return [];
    }
}
```

#### Psalm é›†æˆ

ç±»ä¼¼äºPHPStané›†æˆï¼Œå¯å‚è€ƒä¸Šè¿°æ¨¡å¼å®ç°Psalmé›†æˆã€‚

### åŠŸèƒ½4: æ”¯æŒåŠ¨æ€åˆ†æ

#### Taintæµè¿½è¸ª

```typescript
// src/analyzers/advancedTaintAnalyzer.ts

export class AdvancedTaintAnalyzer {
    // ä½¿ç”¨æ›´å¤æ‚çš„æ±¡ç‚¹åˆ†æç®—æ³•
    // æ”¯æŒï¼š
    // - è·¨å‡½æ•°æ±¡ç‚¹ä¼ æ’­
    // - å­—ç¬¦ä¸²æ“ä½œæ±¡ç‚¹åˆ†æ
    // - æ•°ç»„æ±¡ç‚¹ä¼ æ
    // - å¯¹è±¡å±æ€§æ±¡ç‚¹åˆ†æ
    
    private taintGraph: Map<string, Set<string>> = new Map();
    
    buildTaintGraph(ast: any): void {
        // æ„å»ºæ±¡ç‚¹æµå›¾
    }
    
    traceTaint(variable: string): string[] {
        // è¿½è¸ªå˜é‡çš„æ±¡ç‚¹æº
        return [];
    }
}
```

### åŠŸèƒ½5: æ”¯æŒå¤šä¸ªPHPæ–‡ä»¶çš„è”åˆåˆ†æ

```typescript
// src/analyzers/workspaceAnalyzer.ts

export class WorkspaceAnalyzer {
    async analyzeWorkspace(rootPath: string): Promise<AnalysisResult[]> {
        // 1. æ‰«ææ‰€æœ‰PHPæ–‡ä»¶
        const phpFiles = await this.findPHPFiles(rootPath);
        
        // 2. æ„å»ºè·¨æ–‡ä»¶çš„ç±»/å‡½æ•°ç´¢å¼•
        const index = await this.buildCrossFileIndex(phpFiles);
        
        // 3. æ‰§è¡Œè·¨æ–‡ä»¶åˆ†æ
        const results = await this.performCrossFileAnalysis(phpFiles, index);
        
        return results;
    }
    
    private findPHPFiles(rootPath: string): Promise<string[]> {
        // é€’å½’æŸ¥æ‰¾æ‰€æœ‰.phpæ–‡ä»¶
        return [];
    }
    
    private buildCrossFileIndex(files: string[]): Promise<CrossFileIndex> {
        // æ„å»ºç±»ã€å‡½æ•°ã€å¸¸é‡çš„è·¨æ–‡ä»¶ç´¢å¼•
        return Promise.resolve({});
    }
    
    private performCrossFileAnalysis(
        files: string[],
        index: CrossFileIndex
    ): Promise<AnalysisResult[]> {
        // æ‰§è¡Œè·¨æ–‡ä»¶åˆ†æ
        return Promise.resolve([]);
    }
}
```

### åŠŸèƒ½6: æ”¯æŒå¯¼å‡ºæŠ¥å‘Š

```typescript
// src/exporters/reportExporter.ts

export class ReportExporter {
    async exportToHTML(results: AnalysisResult[]): Promise<string> {
        // ç”ŸæˆHTMLæŠ¥å‘Š
        let html = `<html><head><style>...</style></head><body>`;
        html += `<h1>PHP Security Analysis Report</h1>`;
        // ... æ·»åŠ åˆ†æç»“æœ
        html += `</body></html>`;
        return html;
    }
    
    async exportToJSON(results: AnalysisResult[]): Promise<string> {
        return JSON.stringify(results, null, 2);
    }
    
    async exportToCSV(results: AnalysisResult[]): Promise<string> {
        // ç”ŸæˆCSVæ ¼å¼æŠ¥å‘Š
        return '';
    }
    
    async exportToPDF(results: AnalysisResult[]): Promise<Buffer> {
        // ç”ŸæˆPDFæŠ¥å‘Š
        return Buffer.from('');
    }
}
```

---

## æµ‹è¯•ä¸è°ƒè¯•

### è°ƒè¯•æ–¹æ³•

#### æ–¹æ³•1: VS Code è°ƒè¯•å™¨

1. **è®¾ç½®æ–­ç‚¹**
   - åœ¨ä»£ç ä¸­ç‚¹å‡»è¡Œå·å·¦ä¾§è®¾ç½®æ–­ç‚¹
   - æˆ–ä½¿ç”¨ `debugger;` è¯­å¥

2. **å¯åŠ¨è°ƒè¯•**
   - æŒ‰ `F5` æˆ–ä½¿ç”¨è°ƒè¯•èœå•
   - VS Code ä¼šæ‰“å¼€æ–°çª—å£è¿è¡Œæ‰©å±•

3. **è°ƒè¯•è§†å›¾**
   - å·¦ä¾§è¾¹æ  â†’ è¿è¡Œå’Œè°ƒè¯•
   - æŸ¥çœ‹å˜é‡ã€è°ƒç”¨æ ˆã€è¡¨è¾¾å¼ç­‰

#### æ–¹æ³•2: æ§åˆ¶å°è¾“å‡º

```typescript
// åœ¨æ‰©å±•ä»£ç ä¸­
console.log('Debug message:', variable);

// åœ¨æ‰©å±•è¾“å‡ºçª—å£ä¸­æŸ¥çœ‹
// è¾“å‡º â†’ PHP Security Analyzer
```

#### æ–¹æ³•3: æ—¥å¿—æ–‡ä»¶

```typescript
import * as fs from 'fs';
import * as path from 'path';

export class Logger {
    private logFile: string;

    constructor(workspacePath: string) {
        this.logFile = path.join(workspacePath, '.vscode-analyzer.log');
    }

    log(message: string, data?: any) {
        const timestamp = new Date().toISOString();
        const logMessage = `[${timestamp}] ${message}`;
        const fullMessage = data ? `${logMessage}\n${JSON.stringify(data, null, 2)}` : logMessage;
        
        fs.appendFileSync(this.logFile, fullMessage + '\n');
        console.log(fullMessage);
    }
}
```

### æµ‹è¯•æ¡†æ¶è®¾ç½®

#### å®‰è£…æµ‹è¯•ä¾èµ–

```bash
npm install --save-dev mocha chai @types/mocha
```

#### ç¼–å†™æµ‹è¯•ç”¨ä¾‹

```typescript
// test/vulnerabilityScanner.test.ts

import * as assert from 'assert';
import { VulnerabilityScanner } from '../src/analyzers/vulnerabilityScanner';
import { PHPAnalyzer } from '../src/analyzers/phpAnalyzer';

describe('VulnerabilityScanner', () => {
    it('should detect unsafe unserialize', () => {
        const code = `<?php
        $data = $_GET['input'];
        $obj = unserialize($data);
        ?>`;
        
        const analyzer = new PHPAnalyzer(code);
        const ast = analyzer.getAST();
        const scanner = new VulnerabilityScanner(ast);
        
        // è¿™éœ€è¦ä¸€ä¸ªè™šæ‹Ÿçš„TextDocumentå¯¹è±¡
        const vulns = scanner.scanVulnerabilities(document);
        
        assert.ok(vulns.some(v => v.id === 'DESER-001'));
    });

    it('should detect SQL injection', () => {
        const code = `<?php
        $id = $_GET['id'];
        $query = "SELECT * FROM users WHERE id = " . $id;
        mysqli_query($conn, $query);
        ?>`;
        
        const analyzer = new PHPAnalyzer(code);
        const ast = analyzer.getAST();
        const scanner = new VulnerabilityScanner(ast);
        
        const vulns = scanner.scanVulnerabilities(document);
        
        assert.ok(vulns.some(v => v.id === 'INJ-001'));
    });
});
```

#### è¿è¡Œæµ‹è¯•

```bash
npm test
```

### å¸¸è§é—®é¢˜æ’æŸ¥

#### é—®é¢˜1: PHPä»£ç æ— æ³•è§£æ

**ç—‡çŠ¶**: åˆ†æç»“æœä¸ºç©ºæˆ–é”™è¯¯æç¤º

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// æ£€æŸ¥PHPä»£ç è¯­æ³•
const phpAnalyzer = new PHPAnalyzer(code);
if (!phpAnalyzer.getAST() || !phpAnalyzer.getAST().children) {
    console.error('Invalid PHP code');
    // æ˜¾ç¤ºè¯­æ³•é”™è¯¯æç¤º
}
```

#### é—®é¢˜2: GraphServeræ— æ³•å¯åŠ¨

**ç—‡çŠ¶**: "Failed to start graph server on port 3000"

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
lsof -i :3000  // macOS/Linux

// æ›´æ”¹é…ç½®ä¸­çš„ç«¯å£
åœ¨ VS Code settings.json ä¸­ä¿®æ”¹ phpAnalyzer.graphServerPort
```

#### é—®é¢˜3: é«˜å†…å­˜å ç”¨

**ç—‡çŠ¶**: åˆ†æå¤§æ–‡ä»¶æ—¶å†…å­˜æš´å¢

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// åˆ†å—å¤„ç†å¤§æ–‡ä»¶
const chunkSize = 10000;
for (let i = 0; i < code.length; i += chunkSize) {
    const chunk = code.substring(i, i + chunkSize);
    processChunk(chunk);
}
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ASTç¼“å­˜

```typescript
// src/cache/astCache.ts

export class ASTCache {
    private cache: Map<string, { ast: any; timestamp: number }> = new Map();
    private maxAge: number = 300000; // 5åˆ†é’Ÿ

    getAST(code: string, key: string): any {
        const cached = this.cache.get(key);
        
        if (cached && Date.now() - cached.timestamp < this.maxAge) {
            return cached.ast;
        }
        
        return null;
    }

    setAST(key: string, ast: any): void {
        this.cache.set(key, {
            ast,
            timestamp: Date.now()
        });
    }

    clear(): void {
        this.cache.clear();
    }
}
```

### 2. æ‡’åŠ è½½åˆ†æ

```typescript
// åªåœ¨ç”¨æˆ·éœ€è¦æ—¶æ‰§è¡Œå¤æ‚åˆ†æ

async function lazyAnalyze(code: string, analysisType: string) {
    // æ€»æ˜¯æ‰§è¡Œçš„å¿«é€Ÿæ£€æŸ¥
    const quickResults = performQuickCheck(code);
    
    if (userRequestsDetailed) {
        // å»¶è¿Ÿæ‰§è¡Œçš„è¯¦ç»†åˆ†æ
        const detailedResults = await performDetailedAnalysis(code, analysisType);
        return [...quickResults, ...detailedResults];
    }
    
    return quickResults;
}
```

### 3. å¹¶è¡Œåˆ†æ

```typescript
// src/analyzers/parallelAnalyzer.ts

export class ParallelAnalyzer {
    async analyzeInParallel(code: string): Promise<AnalysisResult[][]> {
        // å¹¶è¡Œæ‰§è¡Œå¤šä¸ªåˆ†æå™¨
        const results = await Promise.all([
            this.runVulnerabilityScanner(code),
            this.runPOPChainDetector(code),
            this.runClassAnalyzer(code),
            this.runDataFlowAnalyzer(code)
        ]);
        
        return results;
    }
    
    private async runVulnerabilityScanner(code: string): Promise<AnalysisResult[]> {
        return new Promise(resolve => {
            // åœ¨Workerçº¿ç¨‹ä¸­è¿è¡Œ
            const worker = new Worker('./workers/vulnerabilityWorker.ts');
            worker.postMessage(code);
            worker.onmessage = (e) => {
                resolve(e.data);
                worker.terminate();
            };
        });
    }
}
```

### 4. å¢é‡åˆ†æ

```typescript
// src/analyzers/incrementalAnalyzer.ts

export class IncrementalAnalyzer {
    private previousAST: any;
    private previousResults: AnalysisResult[] = [];

    async analyzeIncremental(code: string, changes: CodeChange[]): Promise<AnalysisResult[]> {
        // åªé‡æ–°åˆ†ææ”¹åŠ¨çš„éƒ¨åˆ†
        const affectedRanges = this.calculateAffectedRanges(changes);
        
        const newResults = await this.analyzeRanges(code, affectedRanges);
        
        // åˆå¹¶æ—§ç»“æœå’Œæ–°ç»“æœ
        const mergedResults = this.mergeResults(
            this.previousResults,
            newResults,
            affectedRanges
        );
        
        this.previousResults = mergedResults;
        
        return mergedResults;
    }

    private calculateAffectedRanges(changes: CodeChange[]): Range[] {
        // è®¡ç®—å—å½±å“çš„ä»£ç èŒƒå›´
        return [];
    }

    private analyzeRanges(code: string, ranges: Range[]): Promise<AnalysisResult[]> {
        // åªåˆ†ææŒ‡å®šèŒƒå›´
        return Promise.resolve([]);
    }

    private mergeResults(
        oldResults: AnalysisResult[],
        newResults: AnalysisResult[],
        affectedRanges: Range[]
    ): AnalysisResult[] {
        // æ™ºèƒ½åˆå¹¶ç»“æœ
        return [];
    }
}
```

### 5. å†…å­˜ç®¡ç†

```typescript
// åŠæ—¶é‡Šæ”¾å¤§å¯¹è±¡
function analyzeAndCleanup(code: string) {
    const analyzer = new PHPAnalyzer(code);
    const results = performAnalysis(analyzer);
    
    // æ¸…ç†ä¸éœ€è¦çš„å¼•ç”¨
    analyzer['ast'] = null;
    analyzer = null;
    
    return results;
}

// ä½¿ç”¨WeakMapå­˜å‚¨å¯èƒ½å¾ˆå¤§çš„å…³è”æ•°æ®
const largeDataCache = new WeakMap();

function getOrCreateLargeData(key: object): LargeData {
    if (largeDataCache.has(key)) {
        return largeDataCache.get(key);
    }
    
    const data = new LargeData();
    largeDataCache.set(key, data);
    return data;
}
```

### 6. ä»£ç åˆ†å‰²

åœ¨webå‰ç«¯ä¸­ä½¿ç”¨ä»£ç åˆ†å‰²ï¼š

```javascript
// web/index.html
<script type="module">
    import('./graph.js').then(module => {
        // å¼‚æ­¥åŠ è½½å›¾å½¢æ¨¡å—
        module.initializeGraph();
    });
</script>
```

---

## é™„å½•A: å¸¸ç”¨ä»£ç ç‰‡æ®µ

### éå†æ‰€æœ‰æ–¹æ³•ä¸­çš„å±æ€§è®¿é—®

```typescript
function findAllPropertyAccesses(classNode: any, analyzer: PHPAnalyzer): PropertyAccess[] {
    const accesses: PropertyAccess[] = [];
    
    if (!classNode.body) return accesses;
    
    for (const member of classNode.body) {
        if (member.kind === 'method') {
            analyzer.traverse(member, (node) => {
                if (node.kind === 'propertylookup' && node.what?.kind === 'variable') {
                    if (node.what.name === 'this') {
                        accesses.push({
                            property: node.property?.name || '',
                            line: node.loc?.start.line || 0,
                            method: member.name?.name || ''
                        });
                    }
                }
            });
        }
    }
    
    return accesses;
}
```

### æ„å»ºç±»ç»§æ‰¿æ ‘

```typescript
function buildInheritanceTree(classes: any[]): Map<string, string[]> {
    const tree = new Map<string, string[]>();
    const nameToClass = new Map(classes.map(c => [c.name?.name, c]));
    
    for (const cls of classes) {
        const className = cls.name?.name;
        const parentName = cls.extends?.name?.name;
        
        if (parentName && nameToClass.has(parentName)) {
            if (!tree.has(parentName)) {
                tree.set(parentName, []);
            }
            tree.get(parentName)!.push(className);
        }
    }
    
    return tree;
}
```

### è¿½è¸ªå‡½æ•°å‚æ•°æ¥æº

```typescript
function traceParameterSource(functionCall: any, paramIndex: number, analyzer: PHPAnalyzer): string {
    if (!functionCall.arguments || !functionCall.arguments[paramIndex]) {
        return 'unknown';
    }
    
    const param = functionCall.arguments[paramIndex];
    
    if (param.kind === 'variable') {
        // ç®€å•å˜é‡
        return '$' + param.name;
    } else if (param.kind === 'offsetlookup') {
        // æ•°ç»„è®¿é—®
        return param.what?.name + '[...]';
    } else if (param.kind === 'bin') {
        // äºŒå…ƒè¿ç®—
        return `${traceParameterSource(param.left, 0, analyzer)} op ${traceParameterSource(param.right, 0, analyzer)}`;
    } else if (param.kind === 'call') {
        // å‡½æ•°è°ƒç”¨
        return param.what?.name + '()';
    }
    
    return 'literal';
}
```

### å®‰å…¨çš„å­—ç¬¦ä¸²åŒ¹é…

```typescript
function matchesPattern(input: string, patterns: string[]): boolean {
    return patterns.some(pattern => {
        try {
            const regex = new RegExp(pattern, 'i');
            return regex.test(input);
        } catch (e) {
            console.error(`Invalid regex pattern: ${pattern}`, e);
            return false;
        }
    });
}
```

---

## é™„å½•B: é…ç½®å‚è€ƒ

### VS Code æ‰©å±•é…ç½®é¡¹

åœ¨ç”¨æˆ·çš„ `settings.json` ä¸­å¯é…ç½®ï¼š

```json
{
    "phpAnalyzer.enableInlineHints": true,
    "phpAnalyzer.highlightDangerousPatterns": true,
    "phpAnalyzer.showPOPChains": true,
    "phpAnalyzer.graphServerPort": 3000,
    "phpAnalyzer.maxAnalysisDepth": 10,
    "phpAnalyzer.cacheEnabled": true,
    "phpAnalyzer.cacheTTL": 300000,
    "phpAnalyzer.enableAutoAnalysis": true,
    "phpAnalyzer.autoAnalysisDelay": 500
}
```

### ç¯å¢ƒå˜é‡

å¯ä»¥è®¾ç½®ç¯å¢ƒå˜é‡æ¥æ§åˆ¶æ‰©å±•è¡Œä¸ºï¼š

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
DEBUG=vscode-php-analyzer npm run compile

# æŒ‡å®šPHP-Parseré€‰é¡¹
PHP_PARSER_OPTIONS='{"extractDoc":true}' npm run compile

# è®¾ç½®å›¾æœåŠ¡å™¨ç«¯å£
GRAPH_SERVER_PORT=3001 npm run develop
```

---

## é™„å½•C: ç›¸å…³èµ„æº

### PHPå®‰å…¨ç›¸å…³
- [OWASP PHP Top 10](https://owasp.org/www-project-top-ten/)
- [CWE - Common Weakness Enumeration](https://cwe.mitre.org/)
- [PHPå®˜æ–¹æ–‡æ¡£](https://www.php.net/manual/en/)

### POPé“¾ç›¸å…³
- [PHPGGC - PHP Gadget Chains](https://github.com/ambionics/phpggc)
- [ysoserial](https://github.com/frohoff/ysoserial)
- [POP Chainåˆ©ç”¨æ•™ç¨‹](https://www.anquanke.com/post/id/169553)

### å¼€å‘å·¥å…·
- [VS Code æ‰©å±•å¼€å‘æ–‡æ¡£](https://code.visualstudio.com/api)
- [TypeScript å®˜æ–¹æ–‡æ¡£](https://www.typescriptlang.org/docs/)
- [php-parser æ–‡æ¡£](https://github.com/glayzzle/php-parser)

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¸»è¦æ›´æ–° |
|------|------|---------|
| 1.0.0 | 2024-12 | é¦–ä¸ªæ­£å¼ç‰ˆæœ¬ï¼Œå®Œæ•´çš„æ¼æ´æ£€æµ‹å’ŒPOPé“¾åˆ†æåŠŸèƒ½ |

---

## è”ç³»ä¸åé¦ˆ

- **GitHub Issues**: https://github.com/ZUENS2020/vscode_php_analyzer/issues
- **è®¨è®ºåŒº**: https://github.com/ZUENS2020/vscode_php_analyzer/discussions
- **é‚®ä»¶**: [é¡¹ç›®ç»´æŠ¤è€…é‚®ç®±]

---

**æ–‡æ¡£æœ€åæ›´æ–°**: 2024å¹´12æœˆ
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
